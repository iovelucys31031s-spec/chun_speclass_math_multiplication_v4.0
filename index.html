<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ååä¹˜æ³•æŒ‘æˆ°è³½ | å¤æ°ç©æœ¨å¤§å¸«</title>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* å­—é«”è¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');
        
        @font-face {
            font-family: 'Iansui';
            src: url('https://cdn.jsdelivr.net/npm/iansui@0.9.4/data/Iansui-Regular.woff2') format('woff2');
            font-display: swap;
        }

        body {
            font-family: 'Iansui', 'Zen Maru Gothic', 'HiraMaruProN-W4', 'YuRumin', sans-serif;
            background: linear-gradient(180deg, #92A8D1 0%, #F7CAC9 100%);
            background-attachment: fixed;
            color: #555;
            height: 100vh;
            height: 100dvh; /* Dynamic Viewport Height for mobile */
            overflow: hidden;
        }

        /* SEVENTEEN Colors */
        .bg-rose-quartz { background-color: #F7CAC9; }
        .bg-serenity { background-color: #92A8D1; }
        .text-serenity { color: #92A8D1; }
        
        .btn-primary {
            background-color: #92A8D1;
            color: white;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #7a92c0;
            transform: translateY(-2px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* -------------------------------------------
           å¤æ°ç©æœ¨æ¨£å¼ (è¢å¹•äº’å‹•é¡¯ç¤ºç”¨ - ä¿æŒåŸè‰²)
           ------------------------------------------- */
        .rod-base {
            border: 1px solid rgba(0,0,0,0.3); 
            box-sizing: border-box;
            background-image: linear-gradient(0deg, transparent calc(100% - 1px), rgba(255,255,255,0.7) calc(100% - 1px));
            box-shadow: 2px 2px 4px rgba(0,0,0,0.15);
        }

        /* è¢å¹•é¡¯ç¤ºé¡è‰²å®šç¾© */
        .rod-1 { 
            background-color: #ffffff !important; 
            border: 2px solid #94a3b8 !important; /* åŠ æ·±ç™½è‰²ç©æœ¨é‚Šæ¡† */
            box-shadow: inset 0 0 6px rgba(0,0,0,0.1), 2px 2px 4px rgba(0,0,0,0.15) !important;
        }
        .rod-2 { background-color: #ff6b6b !important; }
        .rod-3 { background-color: #96f2d7 !important; }
        .rod-4 { background-color: #d0bfff !important; }
        .rod-5 { background-color: #fcc419 !important; }
        .rod-6 { background-color: #51cf66 !important; }
        .rod-7 { background-color: #212529 !important; color: white; } 
        .rod-8 { background-color: #8B4513 !important; color: white; } 
        .rod-9 { background-color: #339af0 !important; color: white; } 
        .rod-10 { background-color: #ff922b !important; } 

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* é€²åº¦æ¢å‹•ç•« */
        @keyframes progress-stripes {
            from { background-position: 1rem 0; }
            to { background-position: 0 0; }
        }
        .animate-stripes {
            animation: progress-stripes 1s linear infinite;
        }

        /* -------------------------------------------
           å­¸ç¿’å–®æ¨£å¼ (é€šç”¨æ–¼ é è¦½ èˆ‡ åˆ—å°)
           ------------------------------------------- */
        
        /* å­¸ç¿’å–®é é¢å®¹å™¨ */
        .worksheet-page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 10mm 15mm; 
            margin-bottom: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            position: relative;
        }

        /* å­¸ç¿’å–®ä¸Šçš„ç©æœ¨ - åŠ å¼·è¼ªå»“èˆ‡æ ¼ç·šï¼Œèª¿æ•´æ ¼ç·šå¤§å°ç‚º 16px */
        .rod-base-print {
            border: 2px solid black !important; /* ç´”é»‘ç²—æ¡† */
            box-sizing: border-box;
            /* é»‘è‰²æ ¼ç·šï¼Œæ¸…æ™°å¯è¦‹ */
            background-image: linear-gradient(0deg, #000 1px, transparent 1px) !important;
            background-size: 100% 16px !important; 
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* åˆ—å°æ¨¡å¼é¡è‰²èª¿æ•´ (é‡å°æ·±è‰²ç©æœ¨) 
           è®“é»‘è‰²æ ¼ç·šæ›´æ˜é¡¯
        */
        .rod-base-print.rod-7 { background-color: #ced4da !important; color: black !important; } /* é»‘æ”¹æ·ºç° */
        .rod-base-print.rod-8 { background-color: #e0b494 !important; color: black !important; } /* æ£•æ”¹æ·ºæ£• */
        .rod-base-print.rod-9 { background-color: #90cdf4 !important; color: black !important; } /* è—æ”¹æ·ºè— */
        .rod-base-print.rod-10 { background-color: #fbd38d !important; color: black !important; } /* æ©˜æ”¹æ·ºæ©˜ */
        
        /* å…¶ä»–æ·ºè‰²ä¿æŒåŸæ¨£ï¼Œç¢ºä¿æ ¼ç·šå¯è¦‹ */
        .rod-base-print.rod-1 { border: 2px solid #666 !important; } /* ç™½è‰²åŠ æ·±æ¡† */

        /* å­¸ç¿’å–®è¼¸å…¥æ–¹æ¡† */
        .print-input-box {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 2px solid #000 !important; 
            vertical-align: middle;
            margin: 0 4px;
            background: white;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.1); 
        }

        /* =========================================
           åˆ—å°å°ˆç”¨æ¨£å¼ (@media print)
           ========================================= */
        @media print {
            .no-print, .admin-btn, #app > div:not(.print-container) { display: none !important; }
            
            body, html, #app { 
                background: white !important; 
                height: auto !important; 
                overflow: visible !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
            }
            
            .print-container { 
                display: block !important; 
                width: 100% !important; 
                height: auto !important; 
                box-shadow: none !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                overflow: visible !important; 
                background: white !important;
            }

            .worksheet-page {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                min-height: 297mm !important;
                page-break-after: always;
                break-after: page;
            }
            
            .worksheet-page:last-child {
                page-break-after: auto;
                break-after: auto;
            }

            .print-input-box {
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen w-screen">

<div id="app" class="w-full h-full flex flex-col items-center justify-center p-2 md:p-4 relative">

    <!-- Admin Button -->
    <div class="absolute bottom-4 right-4 z-50 no-print admin-btn">
        <button @click="currentView = 'adminLogin'" class="flex items-center gap-2 text-gray-600 hover:text-serenity bg-white/40 hover:bg-white/90 px-4 py-2 rounded-full transition-all shadow-sm backdrop-blur-sm text-sm font-bold border border-white/50">
            <i class="fas fa-cog"></i>
            <span>æ•™å¸«å¾Œå°</span>
        </button>
    </div>

    <!-- MAIN CONTAINER -->
    <div v-if="currentView !== 'worksheetPreview'" class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl h-full max-h-[95vh] flex flex-col relative no-print overflow-hidden">
        
        <!-- VIEW: HOME (Settings) -->
        <div v-if="currentView === 'home'" class="p-4 md:p-6 flex-1 flex flex-col overflow-hidden">
            <h1 class="text-4xl md:text-6xl font-bold text-center text-serenity mb-2 md:mb-4 shrink-0 pt-2 md:pt-4 tracking-tight">ååä¹˜æ³•æŒ‘æˆ°è³½</h1>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide px-1 space-y-2 flex flex-col justify-center">
                <!-- Settings Content -->
                <div class="bg-rose-50 p-2 md:p-4 rounded-2xl shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <label class="font-bold text-lg text-gray-700"><i class="fas fa-list-ol mr-2 text-rose-quartz"></i>é¸æ“‡æŒ‘æˆ°æ•¸å­—</label>
                        <div class="space-x-1">
                            <button @click="selectAllMultipliers" class="text-xs bg-white text-serenity px-3 py-1 rounded border border-serenity hover:bg-serenity hover:text-white transition-colors">å…¨é¸</button>
                            <button @click="settings.multipliers = []" class="text-xs bg-white text-gray-400 px-3 py-1 rounded border border-gray-300 hover:bg-gray-100 transition-colors">æ¸…ç©º</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-2">
                        <label v-for="n in 10" :key="n" class="cursor-pointer relative group">
                            <input type="checkbox" :value="n" v-model="settings.multipliers" class="hidden">
                            <!-- ä¿®æ­£ï¼šä½¿ç”¨å‹•æ…‹ Class å–ä»£ CSS sibling selectorï¼Œè§£æ±ºé»æ“Šè®Šç™½/å»¶é²å•é¡Œ -->
                            <div :class="[
                                'w-full h-10 md:h-12 flex items-center justify-center rounded-lg border-2 transition-all font-bold text-xl shadow-sm select-none',
                                settings.multipliers.includes(n) 
                                    ? 'bg-serenity text-white border-serenity transform scale-105 shadow-md' 
                                    : 'bg-white border-transparent text-gray-400 hover:bg-gray-50'
                            ]">
                                {{ n }}
                                <i v-if="settings.multipliers.includes(n)" class="fas fa-check absolute top-0.5 right-0.5 text-[10px] md:text-xs"></i>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 shrink-0">
                    <div class="bg-rose-50 p-2 md:p-3 rounded-2xl">
                        <label class="font-bold text-gray-700 block mb-1 text-base"><i class="fas fa-calculator mr-2 text-rose-quartz"></i>é¡Œæ•¸</label>
                        <div class="flex items-center h-full max-h-[44px]">
                            <input type="number" v-model.number="settings.questionCount" min="1" max="100" class="w-full h-10 p-2 rounded-lg border-2 border-white focus:border-serenity outline-none bg-white text-center font-bold text-xl">
                            <span class="ml-2 text-gray-500 text-sm whitespace-nowrap">é¡Œ</span>
                        </div>
                    </div>

                    <div class="bg-rose-50 p-2 md:p-3 rounded-2xl flex flex-col justify-center">
                        <label class="font-bold text-gray-700 block mb-1 text-base"><i class="fas fa-shapes mr-2 text-rose-quartz"></i>é¡å‹</label>
                        <div class="flex flex-row gap-2 items-center h-full max-h-[44px]">
                            <button @click="settings.cardType = 'number'" :class="{'bg-serenity text-white': settings.cardType === 'number', 'bg-white text-gray-500': settings.cardType !== 'number'}" class="flex-1 h-10 flex items-center justify-center rounded-lg text-sm transition-all border border-transparent font-medium whitespace-nowrap">ç´”æ•¸å­—</button>
                            <button @click="settings.cardType = 'block'" :class="{'bg-serenity text-white': settings.cardType === 'block', 'bg-white text-gray-500': settings.cardType !== 'block'}" class="flex-1 h-10 flex items-center justify-center rounded-lg text-sm transition-all border border-transparent font-medium whitespace-nowrap">å¤æ°ç©æœ¨</button>
                        </div>
                    </div>
                </div>

                <div class="bg-rose-50 p-2 md:p-3 rounded-2xl shrink-0">
                    <label class="font-bold text-gray-700 block mb-1 text-base"><i class="fas fa-pencil-alt mr-2 text-rose-quartz"></i>æŒ‘æˆ°æ–¹å¼</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div @click="settings.answerMode = 'simple'" :class="{'border-serenity bg-blue-50 ring-2 ring-serenity/20': settings.answerMode === 'simple', 'border-transparent bg-white': settings.answerMode !== 'simple'}" class="p-2 rounded-xl border-2 cursor-pointer transition-all flex flex-col items-center justify-center text-center h-16 md:h-18">
                            <span class="font-bold text-serenity text-base mb-0.5">å¡«å¯«ç­”æ¡ˆ</span>
                            <span class="text-xs text-gray-400 leading-tight">åªéœ€å›ç­”æœ€å¾Œçš„ç©</span>
                        </div>
                        <div @click="settings.answerMode = 'full'" :class="{'border-serenity bg-blue-50 ring-2 ring-serenity/20': settings.answerMode === 'full', 'border-transparent bg-white': settings.answerMode !== 'full'}" class="p-2 rounded-xl border-2 cursor-pointer transition-all flex flex-col items-center justify-center text-center h-16 md:h-18">
                            <span class="font-bold text-serenity text-base mb-0.5">å»ºæ§‹ç®—å¼</span>
                            <span class="text-xs text-gray-400 leading-tight">å¡«å…¥å®Œæ•´ç®—å¼</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3 shrink-0 pb-1">
                <button @click="goToStudentName" :disabled="settings.multipliers.length === 0 || !settings.questionCount || settings.questionCount < 1" class="btn-primary w-full py-3 md:py-4 rounded-2xl text-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg transform active:scale-[0.99] transition-all">
                    ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <div class="h-4 text-center mt-1">
                     <p v-if="settings.multipliers.length === 0" class="text-red-400 text-xs">è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ•¸å­—ï¼</p>
                     <p v-else-if="!settings.questionCount || settings.questionCount < 1" class="text-red-400 text-xs">é¡Œæ•¸å¿…é ˆå¤§æ–¼ 0ï¼</p>
                </div>
            </div>
        </div>

        <!-- VIEW: STUDENT NAME -->
        <div v-if="currentView === 'studentName'" class="p-8 flex-1 flex flex-col items-center justify-center relative">
            <button @click="currentView = 'home'" class="absolute top-8 left-8 text-gray-400 hover:text-serenity"><i class="fas fa-arrow-left mr-1"></i> ä¿®æ”¹è¨­å®š</button>
            <div class="w-full max-w-md text-center">
                <h2 class="text-2xl md:text-3xl font-bold text-serenity mb-8">ä½ å¥½ï¼è«‹å•ä½ çš„åå­—æ˜¯ï¼Ÿ</h2>
                <div class="space-y-4 mb-12">
                    <input type="text" v-model="studentName" placeholder="è¼¸å…¥åå­—..." class="w-full p-4 text-2xl text-center border-b-4 border-rose-quartz focus:border-serenity outline-none bg-transparent transition-colors placeholder-gray-300">
                    
                    <div class="relative">
                        <select v-model="studentGrade" class="w-full p-4 text-xl text-center border-b-4 border-rose-quartz focus:border-serenity outline-none bg-transparent appearance-none text-gray-600 cursor-pointer">
                            <option value="" disabled selected>é¸æ“‡å¹´ç´š</option>
                            <option value="1">ä¸€å¹´ç´š</option>
                            <option value="2">äºŒå¹´ç´š</option>
                            <option value="3">ä¸‰å¹´ç´š</option>
                            <option value="4">å››å¹´ç´š</option>
                            <option value="5">äº”å¹´ç´š</option>
                            <option value="6">å…­å¹´ç´š</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                </div>
                
                <button @click="startQuiz(false)" :disabled="!studentName.trim() || !studentGrade" class="btn-primary w-full py-4 rounded-2xl text-xl font-bold disabled:opacity-50 shadow-md">
                    é–‹å§‹æŒ‘æˆ°ï¼ <i class="fas fa-rocket ml-2"></i>
                </button>
            </div>
        </div>

        <!-- VIEW: QUIZ -->
        <div v-if="currentView === 'quiz'" class="flex-1 flex flex-col h-full overflow-hidden">
            
            <div class="w-full max-w-3xl mx-auto px-4 pt-4 pb-2 shrink-0 flex flex-col gap-2">
                <div class="flex justify-between items-end text-gray-500 font-bold">
                    <div class="flex items-center text-lg text-serenity">
                        <i class="fas fa-user-graduate mr-2"></i>{{ studentName }} <span class="text-xs ml-2 text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">{{ studentGrade }}å¹´ç´š</span>
                    </div>
                    <div class="text-sm bg-white px-3 py-1 rounded-full shadow-sm border border-gray-100 flex items-center">
                        ç¬¬ <span class="text-serenity text-lg font-bold mx-1">{{ currentQuestionIndex + 1 }}</span> / {{ quizQuestions.length }} é¡Œ
                    </div>
                </div>
                <div class="w-full bg-white h-4 rounded-full border border-gray-100 p-0.5 shadow-inner">
                    <div class="bg-serenity h-full rounded-full transition-all duration-500 ease-out relative overflow-hidden" :style="{ width: progressPercent + '%' }">
                        <div class="absolute inset-0 w-full h-full animate-stripes opacity-30 bg-[linear-gradient(45deg,rgba(255,255,255,0.4)_25%,transparent_25%,transparent_50%,rgba(255,255,255,0.4)_50%,rgba(255,255,255,0.4)_75%,transparent_75%,transparent)] bg-[length:1rem_1rem]"></div>
                    </div>
                </div>
            </div>

            <!-- Quiz Content Area -->
            <div class="flex-1 flex flex-col items-center p-2 md:p-4 w-full max-w-3xl mx-auto overflow-hidden">
                <div ref="rodsContainer" class="flex-1 w-full bg-white rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center justify-center mb-4 relative overflow-hidden p-4">
                    
                    <div class="w-full h-full flex flex-col items-center justify-center overflow-hidden">
                        <!-- Mode A: Pure Number -->
                        <div v-if="settings.cardType === 'number'" class="text-[60px] md:text-[100px] font-bold text-gray-600 font-mono tracking-wider">
                            {{ currentQuestion.multiplier }} Ã— {{ currentQuestion.count }}
                        </div>

                        <!-- Mode B: Cuisenaire Rods -->
                        <div v-if="settings.cardType === 'block'" class="flex flex-row items-end justify-center gap-1 md:gap-2 max-h-full w-fit mx-auto transition-all duration-300">
                             <div v-for="r in currentQuestion.count" :key="r" class="flex flex-col items-center shrink-0">
                                <div :class="['rod-base', getRodClass(currentQuestion.multiplier)]" 
                                     :style="getDynamicRodStyle(currentQuestion.multiplier)">
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="w-full shrink-0">
                    <div class="flex flex-wrap items-center justify-center gap-2 text-xl md:text-3xl font-bold text-gray-600 bg-rose-50 p-4 md:p-6 rounded-2xl shadow-inner">
                        <template v-if="settings.answerMode === 'full'">
                            <input ref="inputA" type="number" v-model="userInputs.a" class="w-16 md:w-24 text-center p-2 rounded-xl border-2 border-rose-quartz focus:border-serenity outline-none bg-white" placeholder="?">
                            <span class="text-serenity">Ã—</span>
                            <input type="number" v-model="userInputs.b" class="w-16 md:w-24 text-center p-2 rounded-xl border-2 border-rose-quartz focus:border-serenity outline-none bg-white" placeholder="?">
                            <span class="text-serenity">=</span>
                        </template>
                        <template v-else>
                            <span class="mx-2">{{ currentQuestion.multiplier }} Ã— {{ currentQuestion.count }} = </span>
                        </template>

                        <input ref="inputAns" type="number" v-model="userInputs.ans" @keyup.enter="submitAnswer" class="w-20 md:w-28 text-center p-2 rounded-xl border-2 border-serenity focus:ring-4 focus:ring-serenity/30 outline-none bg-white text-serenity shadow-lg" placeholder="?">
                        
                        <button @click="submitAnswer" class="ml-2 w-12 h-12 md:w-14 md:h-14 rounded-full bg-serenity text-white flex items-center justify-center hover:bg-blue-400 shadow-md active:scale-95 transition-all">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                    <p class="text-center mt-2 text-gray-400 text-xs">è¼¸å…¥å¾ŒæŒ‰ Enter æˆ–æ‰“å‹¾</p>
                </div>
            </div>
        </div>

        <!-- VIEW: RESULT -->
        <div v-if="currentView === 'result'" class="p-6 md:p-8 flex-1 flex flex-col items-center overflow-y-auto">
            <h2 class="text-3xl font-bold text-serenity mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
            <div class="text-6xl mb-4">ğŸ‰</div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-rose-100 w-full max-w-2xl mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-4">
                    <span class="text-gray-500 font-bold text-lg">ç­”å°ç‡</span>
                    <span class="text-3xl font-bold" :class="scoreColor">{{ scorePercentage }}%</span>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl">
                    <h3 class="font-bold text-serenity mb-2"><i class="fas fa-robot mr-2"></i>AI å°è€å¸«çš„å»ºè­°</h3>
                    <!-- AI Suggestion Display -->
                    <div class="space-y-3 text-sm text-gray-700">
                        <p v-if="aiFeedback.mastered.length > 0">
                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                            ä½ çš„ <strong>{{ aiFeedback.mastered.join('ã€') }}</strong> çš„ä¹˜æ³•å·²ç¶“å¾ˆç†Ÿæ‚‰äº†ï¼<br>
                            <span class="text-gray-500 text-xs ml-5">å»ºè­°ï¼šå˜—è©¦å¿ƒç®—ï¼ŒæŒ‘æˆ°æ›´å¿«çš„é€Ÿåº¦ã€‚</span>
                        </p>
                        <p v-if="aiFeedback.intermediate.length > 0">
                            <i class="fas fa-exclamation-circle text-yellow-500 mr-1"></i>
                            ä½† <strong>{{ aiFeedback.intermediate.join('ã€') }}</strong> çš„ä¹˜æ³•é‚„æœ‰éƒ¨åˆ†ä¸ç†Ÿç·´ã€‚<br>
                            <span class="text-gray-500 text-xs ml-5">å»ºè­°ï¼šå¤šç·´ç¿’å¹¾æ¬¡ï¼Œå¯ä»¥é‚Šå”¸å£è¨£é‚Šå¯«ã€‚</span>
                        </p>
                        <p v-if="aiFeedback.unfamiliar.length > 0">
                            <i class="fas fa-times-circle text-red-500 mr-1"></i>
                            <strong>{{ aiFeedback.unfamiliar.join('ã€') }}</strong> çš„ä¹˜æ³•æœ‰è¼ƒå¤šéœ€è¦å†ç·´ç¿’ã€‚<br>
                            <span class="text-gray-500 text-xs ml-5">å»ºè­°ï¼šæ‹¿å‡ºç©æœ¨æ’æ’çœ‹ï¼Œæˆ–æ˜¯æ‰¾æ‰¾ç”Ÿæ´»ä¸­æœ‰æ²’æœ‰ç›¸é—œæ•¸é‡çš„ç‰©å“ã€‚</span>
                        </p>
                        <p v-if="aiFeedback.mastered.length === 0 && aiFeedback.intermediate.length === 0 && aiFeedback.unfamiliar.length === 0">
                            æ­å–œå®Œæˆï¼ç¹¼çºŒä¿æŒç·´ç¿’å–”ï¼
                        </p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-2xl shrink-0">
                <button @click="currentView = 'home'" class="btn-primary py-3 rounded-xl font-bold">
                    <i class="fas fa-home mr-2"></i> å›åˆ°é¦–é 
                </button>
                <button v-if="wrongQuestions.length > 0" @click="retryWrong" class="btn-secondary py-3 rounded-xl font-bold bg-white">
                    <i class="fas fa-redo mr-2"></i> éŒ¯èª¤é¡Œç›®å†è©¦ä¸€æ¬¡
                </button>
                <button @click="exportResultTxt" class="md:col-span-2 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                    <i class="fas fa-file-export mr-2"></i> åŒ¯å‡ºä½œç­”ç´€éŒ„ (TXT)
                </button>
            </div>
        </div>

        <!-- ADMIN VIEWS (Login/Dashboard) -->
        <div v-if="currentView === 'adminLogin'" class="p-8 flex-1 flex flex-col items-center justify-center">
            <div class="bg-white p-8 rounded-3xl shadow-lg border border-gray-100 w-full max-w-sm text-center">
                <div class="w-16 h-16 bg-rose-100 rounded-full flex items-center justify-center mx-auto mb-4 text-rose-500 text-2xl"><i class="fas fa-lock"></i></div>
                <h2 class="text-xl font-bold text-gray-700 mb-6">å¾Œå°ç®¡ç†ç™»å…¥</h2>
                <input type="password" v-model="adminInputPass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full p-3 rounded-xl border border-gray-300 mb-4 text-center focus:border-serenity outline-none">
                <div class="flex gap-2">
                    <button @click="currentView = 'home'" class="flex-1 py-2 rounded-xl border border-gray-300 text-gray-500">å–æ¶ˆ</button>
                    <button @click="checkAdminPass" class="flex-1 py-2 rounded-xl bg-serenity text-white font-bold">ç™»å…¥</button>
                </div>
                <p v-if="loginMsg" class="text-red-400 text-sm mt-3">{{ loginMsg }}</p>
            </div>
        </div>

        <div v-if="currentView === 'adminDashboard'" class="flex-1 flex flex-col h-full bg-gray-50 overflow-hidden rounded-b-3xl">
            <!-- Sidebar & Tabs -->
            <div class="bg-white border-b border-gray-200 p-4 flex justify-between items-center shrink-0">
                <h2 class="font-bold text-lg text-gray-700"><i class="fas fa-chart-pie text-serenity mr-2"></i>æ•™å¸«å¾Œå°</h2>
                <button @click="currentView = 'home'" class="text-sm text-gray-500 hover:text-serenity"><i class="fas fa-sign-out-alt mr-1"></i> é›¢é–‹</button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-40 bg-white border-r border-gray-200 flex flex-col p-4 space-y-2 hidden md:flex shrink-0">
                    <button @click="adminTab = 'records'" :class="{'bg-rose-50 text-rose-500 font-bold': adminTab === 'records'}" class="text-left p-3 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">å­¸ç”Ÿç´€éŒ„</button>
                    <button @click="adminTab = 'worksheet'" :class="{'bg-rose-50 text-rose-500 font-bold': adminTab === 'worksheet'}" class="text-left p-3 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">è£½ä½œå­¸ç¿’å–®</button>
                    <button @click="adminTab = 'criteria'" :class="{'bg-rose-50 text-rose-500 font-bold': adminTab === 'criteria'}" class="text-left p-3 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">ç²¾ç†Ÿç§’æ•¸è¨­å®š</button>
                    <button @click="adminTab = 'password'" :class="{'bg-rose-50 text-rose-500 font-bold': adminTab === 'password'}" class="text-left p-3 rounded-xl text-gray-600 hover:bg-gray-50 transition-colors">å¯†ç¢¼è¨­å®š</button>
                </div>
                <div class="flex-1 p-4 md:p-6 overflow-y-auto">
                    <!-- Mobile Tabs -->
                    <div class="flex md:hidden mb-4 space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                        <button @click="adminTab = 'records'" class="px-4 py-2 rounded-full whitespace-nowrap text-sm" :class="adminTab === 'records' ? 'bg-serenity text-white' : 'bg-white border'">ç´€éŒ„</button>
                        <button @click="adminTab = 'worksheet'" class="px-4 py-2 rounded-full whitespace-nowrap text-sm" :class="adminTab === 'worksheet' ? 'bg-serenity text-white' : 'bg-white border'">å­¸ç¿’å–®</button>
                        <button @click="adminTab = 'criteria'" class="px-4 py-2 rounded-full whitespace-nowrap text-sm" :class="adminTab === 'criteria' ? 'bg-serenity text-white' : 'bg-white border'">ç²¾ç†Ÿç§’æ•¸</button>
                        <button @click="adminTab = 'password'" class="px-4 py-2 rounded-full whitespace-nowrap text-sm" :class="adminTab === 'password' ? 'bg-serenity text-white' : 'bg-white border'">å¯†ç¢¼</button>
                    </div>

                    <!-- Record List -->
                    <div v-if="adminTab === 'records'">
                        <div class="flex flex-wrap gap-2 justify-between items-center mb-4">
                            <h3 class="font-bold text-xl">ä½œç­”ç´€éŒ„åˆ—è¡¨</h3>
                            <div class="space-x-2">
                                <button @click="exportAllRecords('txt')" class="text-sm bg-white border border-gray-300 px-3 py-1 rounded shadow-sm hover:bg-gray-50">åŒ¯å‡º TXT</button>
                                <button @click="exportAllRecords('csv')" class="text-sm bg-green-50 text-green-700 border border-green-200 px-3 py-1 rounded shadow-sm hover:bg-green-100"><i class="fas fa-file-excel mr-1"></i>åŒ¯å‡º Excel(CSV)</button>
                            </div>
                        </div>
                        <div v-if="studentRecords.length === 0" class="text-center py-10 text-gray-400">ç›®å‰æ²’æœ‰ä½œç­”è³‡æ–™</div>
                        <div class="space-y-3">
                            <div v-for="(rec, index) in studentRecords" :key="index" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-lg text-gray-800">{{ rec.name }}</span>
                                        <span v-if="rec.grade" class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">{{ rec.grade }}å¹´ç´š</span>
                                        <span class="text-xs text-gray-400">{{ rec.timestamp }}</span>
                                    </div>
                                    <div class="text-sm text-gray-500 mt-1">
                                        ç¯„åœ: {{ rec.range }} | é¡Œæ•¸: {{ rec.total }} | <span :class="rec.score >= 80 ? 'text-green-500' : 'text-red-400'">æ­£ç¢ºç‡: {{ rec.score }}%</span>
                                    </div>
                                </div>
                                <div class="flex gap-2 w-full md:w-auto">
                                    <button @click="viewRecordDetail(rec)" class="flex-1 md:flex-none px-4 py-2 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100 text-sm">è©³ç´°</button>
                                    <button @click="deleteRecord(index)" class="px-3 py-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Worksheet Generator -->
                    <div v-if="adminTab === 'worksheet'">
                        <h3 class="font-bold text-xl mb-4">å­¸ç¿’å–®ç”¢ç”Ÿå™¨</h3>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <!-- Settings -->
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-600 mb-2">æ•¸å­—ç¯„åœ</label>
                                <div class="flex flex-wrap gap-2">
                                    <label v-for="n in 10" :key="'w'+n" class="inline-flex items-center bg-gray-50 px-3 py-1 rounded border cursor-pointer hover:bg-gray-100">
                                        <input type="checkbox" :value="n" v-model="worksheetSettings.multipliers" class="mr-2 text-serenity">
                                        {{ n }}
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-600 mb-1">é¡Œæ•¸</label>
                                    <input type="number" v-model="worksheetSettings.count" class="w-full border rounded p-2" min="1" max="100">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-600 mb-1">é¡å‹</label>
                                    <select v-model="worksheetSettings.type" class="w-full border rounded p-2">
                                        <option value="number">ç´”æ•¸å­—</option>
                                        <option value="block">å¤æ°ç©æœ¨</option>
                                    </select>
                                </div>
                            </div>
                             <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-600 mb-1">ä½œç­”æ¬„ä½</label>
                                <select v-model="worksheetSettings.mode" class="w-full border rounded p-2">
                                    <option value="simple">å¡«å¯«ç­”æ¡ˆ ( ___ )</option>
                                    <option value="full">å»ºæ§‹ç®—å¼ ( __ x __ = __ )</option>
                                </select>
                            </div>
                            <button @click="previewWorksheet" class="w-full bg-serenity text-white font-bold py-3 rounded-xl hover:bg-blue-400"><i class="fas fa-eye mr-2"></i> é è¦½å­¸ç¿’å–®</button>
                        </div>
                    </div>
                    
                    <!-- Criteria Settings -->
                    <div v-if="adminTab === 'criteria'">
                        <h3 class="font-bold text-xl mb-4">ç²¾ç†Ÿç§’æ•¸è¨­å®š (ç§’)</h3>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-6">
                            
                            <!-- Explanation Block -->
                            <div class="bg-yellow-50 p-4 rounded border border-yellow-200 text-sm text-gray-700">
                                <p class="font-bold mb-2 text-base"><i class="fas fa-info-circle mr-1"></i> è¨­å®šèªªæ˜ï¼š</p>
                                <ul class="list-disc pl-5 space-y-1 mb-2">
                                    <li>è¨­å®šå­¸ç”Ÿç­”é¡Œæ™‚é–“ä½æ–¼å¤šå°‘ç§’è¦–ç‚ºã€Œç²¾ç†Ÿã€æˆ–ã€Œä¸­ç­‰ã€ï¼Œè¶…éå‰‡è¦–ç‚ºã€Œä¸ç†Ÿã€ã€‚</li>
                                    <li>åƒ…åœ¨ã€Œç­”å°ã€æ™‚è¨ˆç®—ç§’æ•¸ã€‚</li>
                                </ul>
                                <p class="text-xs text-gray-500 bg-white p-2 rounded border border-yellow-100">
                                    <strong>ç¯„ä¾‹ï¼š</strong>åœ¨ã€Œå¡«å¯«ç­”æ¡ˆã€æ¨¡å¼ä¸­ï¼Œè‹¥ç²¾ç†Ÿç§’æ•¸è¨­å®šç‚º <strong>5</strong>ï¼Œä»£è¡¨å­¸ç”Ÿåœ¨ <strong>5 ç§’å…§</strong> è¼¸å…¥å®Œç­”æ¡ˆä¸¦æŒ‰ä¸‹é€å‡ºï¼Œå³åˆ¤å®šç‚ºã€Œç²¾ç†Ÿã€ã€‚
                                </p>
                            </div>
                            
                            <!-- Low Grade -->
                            <div class="bg-rose-50/50 p-4 rounded-xl border border-rose-100">
                                <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 border-b border-rose-200 pb-2">
                                    <div class="flex items-center mb-2 md:mb-0">
                                        <span class="text-xl mr-2">ğŸŒ±</span>
                                        <h4 class="font-bold text-gray-700 mr-2">ä½å¹´ç´š (1-2å¹´ç´š)</h4>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">
                                        <div class="font-bold text-rose-400 mb-0.5">åƒè€ƒå»ºè­°(å¹³æ¿/è§¸æ§)</div>
                                        å¡«å¯«: ç²¾ç†Ÿ <8s / ä¸­ç­‰ <15s &nbsp;|&nbsp; å»ºæ§‹: ç²¾ç†Ÿ <20s / ä¸­ç­‰ <30s
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-0">
                                    <div class="md:border-r md:border-rose-200 md:pr-6 pb-4 md:pb-0">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å¡«å¯«ç­”æ¡ˆ ( ___ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center mb-2">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.low.simple.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-rose-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.low.simple.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-rose-300 outline-none"></div>
                                        </div>
                                    </div>
                                    <div class="md:pl-6 pt-4 md:pt-0 border-t md:border-t-0 border-rose-200">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å»ºæ§‹ç®—å¼ ( _ x _ = _ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.low.full.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-rose-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.low.full.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-rose-300 outline-none"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mid Grade -->
                            <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                                <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 border-b border-blue-200 pb-2">
                                    <div class="flex items-center mb-2 md:mb-0">
                                        <span class="text-xl mr-2">ğŸŒ¿</span>
                                        <h4 class="font-bold text-gray-700 mr-2">ä¸­å¹´ç´š (3-4å¹´ç´š)</h4>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">
                                        <div class="font-bold text-blue-400 mb-0.5">åƒè€ƒå»ºè­°(å¹³æ¿/è§¸æ§)</div>
                                        å¡«å¯«: ç²¾ç†Ÿ <6s / ä¸­ç­‰ <12s &nbsp;|&nbsp; å»ºæ§‹: ç²¾ç†Ÿ <15s / ä¸­ç­‰ <25s
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-0">
                                    <div class="md:border-r md:border-blue-200 md:pr-6 pb-4 md:pb-0">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å¡«å¯«ç­”æ¡ˆ ( ___ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center mb-2">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.mid.simple.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-blue-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.mid.simple.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-blue-300 outline-none"></div>
                                        </div>
                                    </div>
                                    <div class="md:pl-6 pt-4 md:pt-0 border-t md:border-t-0 border-blue-200">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å»ºæ§‹ç®—å¼ ( _ x _ = _ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.mid.full.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-blue-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.mid.full.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-blue-300 outline-none"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                             <!-- High Grade -->
                             <div class="bg-purple-50/50 p-4 rounded-xl border border-purple-100">
                                <div class="flex flex-col md:flex-row md:items-end justify-between mb-4 border-b border-purple-200 pb-2">
                                    <div class="flex items-center mb-2 md:mb-0">
                                        <span class="text-xl mr-2">ğŸŒ³</span>
                                        <h4 class="font-bold text-gray-700 mr-2">é«˜å¹´ç´š (5-6å¹´ç´š)</h4>
                                    </div>
                                    <div class="text-xs text-gray-500 text-right">
                                        <div class="font-bold text-purple-400 mb-0.5">åƒè€ƒå»ºè­°(å¹³æ¿/è§¸æ§)</div>
                                        å¡«å¯«: ç²¾ç†Ÿ <4s / ä¸­ç­‰ <8s &nbsp;|&nbsp; å»ºæ§‹: ç²¾ç†Ÿ <12s / ä¸­ç­‰ <20s
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-0">
                                    <div class="md:border-r md:border-purple-200 md:pr-6 pb-4 md:pb-0">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å¡«å¯«ç­”æ¡ˆ ( ___ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center mb-2">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.high.simple.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-purple-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.high.simple.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-purple-300 outline-none"></div>
                                        </div>
                                    </div>
                                    <div class="md:pl-6 pt-4 md:pt-0 border-t md:border-t-0 border-purple-200">
                                        <h5 class="text-sm font-bold text-serenity mb-2 text-center md:text-left">å»ºæ§‹ç®—å¼ ( _ x _ = _ )</h5>
                                        <div class="flex justify-center md:justify-start gap-4 text-sm items-center">
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ç²¾ç†Ÿ</label><input type="number" v-model.number="proficiencySettings.high.full.mastered" class="w-16 border rounded p-1 text-center bg-white focus:border-purple-300 outline-none"></div>
                                            <div class="flex items-center gap-2"><label class="text-gray-500">ä¸­ç­‰</label><input type="number" v-model.number="proficiencySettings.high.full.intermediate" class="w-16 border rounded p-1 text-center bg-white focus:border-purple-300 outline-none"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button @click="saveProficiencySettings" class="w-full bg-serenity text-white py-3 px-4 rounded-xl font-bold hover:bg-blue-400 transition-colors shadow-sm"><i class="fas fa-save mr-2"></i> å„²å­˜è¨­å®š</button>
                        </div>
                    </div>

                    <!-- Password -->
                    <div v-if="adminTab === 'password'">
                         <h3 class="font-bold text-xl mb-4">å¯†ç¢¼è¨­å®š</h3>
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-md">
                            <div class="mb-4">
                                <label class="block text-sm text-gray-500 mb-1">ç›®å‰å¯†ç¢¼</label>
                                <div class="flex items-center gap-2">
                                    <input :type="showPass ? 'text' : 'password'" :value="currentPassword" readonly class="flex-1 bg-gray-50 border rounded p-2 text-gray-600">
                                    <button @click="showPass = !showPass" class="text-gray-400 hover:text-serenity"><i class="fas" :class="showPass ? 'fa-eye-slash' : 'fa-eye'"></i></button>
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm text-gray-500 mb-1">æ–°å¯†ç¢¼</label>
                                <input type="text" v-model="newPassword" class="w-full border rounded p-2 focus:border-serenity outline-none" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
                            </div>
                            <div class="flex gap-2">
                                <button @click="updatePassword" class="flex-1 bg-serenity text-white py-2 rounded-lg font-bold">ä¿®æ”¹å¯†ç¢¼</button>
                                <button @click="resetPassword" class="flex-1 border border-red-200 text-red-400 py-2 rounded-lg hover:bg-red-50">æ¢å¾©é è¨­</button>
                            </div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Detail Modal -->
            <div v-if="showDetailModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col shadow-2xl overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-rose-50">
                        <h3 class="font-bold text-lg text-gray-700">è©³ç´°ä½œç­”æƒ…å½¢</h3>
                        <button @click="showDetailModal = false" class="text-gray-400 hover:text-red-400"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto">
                        <div class="mb-4 bg-gray-50 p-3 rounded-lg text-sm space-y-2">
                            <div class="flex justify-between">
                                <p><strong>å­¸ç”Ÿï¼š</strong>{{ selectedRecord.name }} <span class="text-gray-500 text-xs">({{ selectedRecord.grade || 'æœªç´€éŒ„' }}å¹´ç´š)</span></p>
                                <p class="text-gray-400 text-xs">{{ selectedRecord.timestamp }}</p>
                            </div>
                            <!-- Display Snapshot Settings -->
                            <div v-if="selectedRecord.settingsSnapshot" class="text-xs text-gray-500 bg-white p-2 rounded border border-gray-200">
                                <strong>ç•¶æ™‚ç²¾ç†Ÿæ¨™æº– ({{ selectedRecord.grade }}å¹´ç´š)ï¼š</strong><br>
                                å¡«å¯«ç­”æ¡ˆ: ç²¾ç†Ÿ <{{ selectedRecord.settingsSnapshot.simple.mastered }}s, ä¸­ç­‰ <{{ selectedRecord.settingsSnapshot.simple.intermediate }}s<br>
                                å»ºæ§‹ç®—å¼: ç²¾ç†Ÿ <{{ selectedRecord.settingsSnapshot.full.mastered }}s, ä¸­ç­‰ <{{ selectedRecord.settingsSnapshot.full.intermediate }}s
                            </div>
                            <p class="mt-2 text-gray-600 border-t border-gray-200 pt-2"><strong>AI å»ºè­°æ‘˜è¦ï¼š</strong><br>
                                <span v-if="selectedRecord.aiFeedbackText">{{ selectedRecord.aiFeedbackText }}</span>
                                <span v-else>ç„¡å»ºè­°</span>
                            </p>
                        </div>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b text-gray-500">
                                    <th class="text-left py-2">é¡Œç›®</th>
                                    <th class="text-center">å­¸ç”Ÿç­”æ¡ˆ</th>
                                    <th class="text-center">ç²¾ç†Ÿåº¦(ä½œç­”ç§’æ•¸)</th>
                                    <th class="text-right">çµæœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(d, i) in selectedRecord.details" :key="i" class="border-b border-gray-50">
                                    <td class="py-2">{{ d.q }}</td>
                                    <td class="text-center font-mono text-gray-600">{{ d.userAns }}</td>
                                    <td class="text-center">
                                        <span v-if="d.proficiency === 'mastered'" class="text-green-500 text-xs px-2 py-0.5 bg-green-50 rounded-full">ç²¾ç†Ÿ ({{ d.time }})</span>
                                        <span v-else-if="d.proficiency === 'intermediate'" class="text-yellow-600 text-xs px-2 py-0.5 bg-yellow-50 rounded-full">ä¸­ç­‰ ({{ d.time }})</span>
                                        <span v-else class="text-red-500 text-xs px-2 py-0.5 bg-red-50 rounded-full">ä¸ç†Ÿ ({{ d.time }})</span>
                                    </td>
                                    <td class="text-right"><i v-if="d.correct" class="fas fa-check text-green-400"></i><i v-else class="fas fa-times text-red-400"></i></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t flex flex-col gap-3">
                         <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ç”¢ç”ŸåŠ å¼·ç·´ç¿’å–®ï¼š</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="generateRemedialWorksheet(selectedRecord, 'intermediate')" class="bg-yellow-100 text-yellow-700 py-2 rounded-lg text-sm font-bold hover:bg-yellow-200 border border-yellow-200">
                                    <i class="fas fa-exclamation-circle mr-1"></i> åƒ…ä¸­ç­‰
                                </button>
                                <button @click="generateRemedialWorksheet(selectedRecord, 'unfamiliar')" class="bg-red-100 text-red-600 py-2 rounded-lg text-sm font-bold hover:bg-red-200 border border-red-200">
                                    <i class="fas fa-times-circle mr-1"></i> åƒ…ä¸ç†Ÿ
                                </button>
                                <button @click="generateRemedialWorksheet(selectedRecord, 'both')" class="bg-orange-100 text-orange-600 py-2 rounded-lg text-sm font-bold hover:bg-orange-200 border border-orange-200">
                                    <i class="fas fa-layer-group mr-1"></i> å…¨éƒ¨ (ä¸­+ä¸)
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="exportSingleRecord(selectedRecord, 'txt')" class="flex-1 bg-serenity text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-400 mt-1">
                                <i class="fas fa-file-export mr-2"></i> åŒ¯å‡º TXT
                            </button>
                             <button @click="exportSingleRecord(selectedRecord, 'csv')" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 mt-1">
                                <i class="fas fa-file-excel mr-2"></i> åŒ¯å‡º Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: WORKSHEET PREVIEW (Paginated) -->
    <div v-if="currentView === 'worksheetPreview'" class="w-full h-full flex flex-col items-center bg-gray-100 overflow-y-auto pt-4 print-container">
        <!-- Toolbar -->
        <div class="w-full max-w-[210mm] flex justify-between items-center mb-4 px-4 no-print shrink-0">
            <button @click="currentView = 'adminDashboard'" class="bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600"><i class="fas fa-arrow-left mr-2"></i> è¿”å›å¾Œå°</button>
            <div class="text-gray-600 font-bold">{{ worksheetTitle }}</div>
            <button @click="printCurrentView" class="bg-serenity text-white px-4 py-2 rounded-lg shadow hover:bg-blue-400 font-bold"><i class="fas fa-print mr-2"></i> åˆ—å° / å¦å­˜ PDF</button>
        </div>

        <!-- Render Paginated Pages -->
        <div v-for="(pageQuestions, pIdx) in paginatedQuestions" :key="pIdx" class="worksheet-page">
            
            <div class="text-center border-b-2 border-black pb-2 mb-4">
                <h1 class="text-3xl font-bold mb-2">{{ worksheetTitle }}</h1>
                <div class="flex flex-row justify-between items-center text-lg mt-2 px-4 whitespace-nowrap">
                    <span>å§“åï¼š____________________</span>
                    <span>æ—¥æœŸï¼š____________________</span>
                    <span>åˆ†æ•¸ï¼š____________________</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-x-8 gap-y-6">
                <div v-for="(q, idx) in pageQuestions" :key="idx" class="break-inside-avoid mb-2 border border-gray-300 rounded-xl p-3">
                    <div class="text-lg font-bold mb-2 bg-gray-100 inline-block px-2 rounded">ç¬¬ {{ (pIdx * 6) + idx + 1 }} é¡Œ</div>
                    
                    <!-- Content -->
                    <div class="min-h-[100px] flex items-center justify-center mb-2">
                        <!-- Number Type -->
                        <div v-if="worksheetSettings.type === 'number'" class="text-5xl font-mono">{{ q.multiplier }} Ã— {{ q.count }}</div>
                        
                        <!-- Rod Type (Vertical Standing) -->
                        <div v-if="worksheetSettings.type === 'block'" class="flex flex-row items-end justify-center gap-1">
                            <div v-for="r in q.count" :key="r" class="flex flex-col items-center">
                                 <div :class="['rod-base-print', getRodClass(q.multiplier)]" 
                                      :style="{ width: '16px', height: (q.multiplier * 16) + 'px' }">
                                 </div>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Area (Square Boxes) -->
                    <div class="border-t-2 border-dashed border-gray-300 pt-3 flex justify-center items-center text-xl">
                        <div v-if="worksheetSettings.mode === 'simple'" class="flex items-center gap-2">
                             <span>{{ q.multiplier }} Ã— {{ q.count }} = </span>
                             <div class="print-input-box"></div>
                        </div>
                        <div v-else class="flex items-center gap-1">
                             <div class="print-input-box"></div>
                             <span class="mx-1">Ã—</span>
                             <div class="print-input-box"></div>
                             <span class="mx-1">=</span>
                             <div class="print-input-box"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="absolute bottom-4 right-4 text-xs text-gray-400">
                ç¬¬ {{ pIdx + 1 }} é  / å…± {{ paginatedQuestions.length }} é  - ååä¹˜æ³•æŒ‘æˆ°è³½
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, reactive, watch, nextTick } = Vue;

    createApp({
        setup() {
            const currentView = ref('home');
            const studentName = ref('');
            const studentGrade = ref(''); // Added Grade Selection
            const isMobile = ref(window.innerWidth < 768);
            
            const settings = reactive({
                multipliers: [2],
                questionCount: 10,
                cardType: 'block',
                answerMode: 'full'
            });
            
            // Proficiency Settings (Updated Logic: Tiered)
            const defaultProficiency = {
                low: { simple: { mastered: 8, intermediate: 15 }, full: { mastered: 20, intermediate: 30 } },
                mid: { simple: { mastered: 6, intermediate: 12 }, full: { mastered: 15, intermediate: 25 } },
                high: { simple: { mastered: 4, intermediate: 8 }, full: { mastered: 12, intermediate: 20 } }
            };

            // Load or Init settings (Migration Logic included)
            let storedProf = JSON.parse(localStorage.getItem('proficiencySettings'));
            if (!storedProf || !storedProf.low) { // If missing or old format
                storedProf = defaultProficiency;
                localStorage.setItem('proficiencySettings', JSON.stringify(storedProf));
            }
            const proficiencySettings = reactive(storedProf);

            const quizQuestions = ref([]);
            const currentQuestionIndex = ref(0);
            const userInputs = reactive({ a: '', b: '', ans: '' });
            const quizResults = ref([]);
            const questionStartTime = ref(0);
            const rodsContainer = ref(null);
            const containerHeight = ref(400); 

            // Admin vars
            const adminInputPass = ref('');
            const currentPassword = ref(localStorage.getItem('adminPass') || '0000');
            const loginMsg = ref('');
            const adminTab = ref('records');
            const studentRecords = ref(JSON.parse(localStorage.getItem('studentRecords') || '[]'));
            const showDetailModal = ref(false);
            const selectedRecord = ref({});
            const showPass = ref(false);
            const newPassword = ref('');
            
            // Worksheet vars
            const worksheetSettings = reactive({
                multipliers: [1,2,3,4,5],
                count: 6,
                type: 'block',
                mode: 'simple'
            });
            const worksheetQuestions = ref([]);
            const worksheetTitle = ref('');

            // Pagination for worksheet
            const paginatedQuestions = computed(() => {
                const pages = [];
                const items = worksheetQuestions.value;
                for (let i = 0; i < items.length; i += 6) {
                    pages.push(items.slice(i, i + 6));
                }
                return pages;
            });

            onMounted(() => {
                window.addEventListener('resize', () => { isMobile.value = window.innerWidth < 768; });
                const resizeObserver = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        containerHeight.value = entry.contentRect.height;
                    }
                });
                watch(currentView, (newVal) => {
                    if (newVal === 'quiz') {
                        nextTick(() => { if(rodsContainer.value) resizeObserver.observe(rodsContainer.value); });
                    } else {
                        resizeObserver.disconnect();
                    }
                });
            });

            const currentQuestion = computed(() => {
                if (quizQuestions.value.length === 0) return { multiplier: 0, count: 0 };
                return quizQuestions.value[currentQuestionIndex.value];
            });

            const progressPercent = computed(() => {
                if (quizQuestions.value.length === 0) return 0;
                return ((currentQuestionIndex.value) / quizQuestions.value.length) * 100;
            });

            const scorePercentage = computed(() => {
                const correct = quizResults.value.filter(r => r.correct).length;
                return Math.round((correct / quizResults.value.length) * 100) || 0;
            });

            const scoreColor = computed(() => {
                if (scorePercentage.value >= 90) return 'text-green-500';
                if (scorePercentage.value >= 60) return 'text-blue-500';
                return 'text-red-400';
            });

            const wrongQuestions = computed(() => quizResults.value.filter(r => !r.correct));

            const aiFeedback = computed(() => {
                const groups = { mastered: [], intermediate: [], unfamiliar: [] };
                const multiplierStats = {}; 

                quizResults.value.forEach(r => {
                    const m = r.details.multiplier;
                    if(!multiplierStats[m]) multiplierStats[m] = [];
                    
                    if(r.proficiency === 'mastered') multiplierStats[m].push(3);
                    else if(r.proficiency === 'intermediate') multiplierStats[m].push(2);
                    else multiplierStats[m].push(1);
                });

                for (const [m, scores] of Object.entries(multiplierStats)) {
                    const avg = scores.reduce((a,b)=>a+b,0) / scores.length;
                    if(avg > 2.5) groups.mastered.push(m);
                    else if(avg > 1.5) groups.intermediate.push(m);
                    else groups.unfamiliar.push(m);
                }
                return groups;
            });

            const selectAllMultipliers = () => { settings.multipliers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; };
            const goToStudentName = () => { currentView.value = 'studentName'; };

            // Helper to determine grade group
            const getGradeGroup = (g) => {
                const grade = parseInt(g);
                if (grade <= 2) return 'low';
                if (grade <= 4) return 'mid';
                return 'high';
            };

            // 3. New Fair Distribution Logic
            const generateQuestionPool = (multipliers, totalCount, isRetry = false, retryPool = []) => {
                let pool = [];
                if (isRetry && retryPool.length > 0) {
                    return retryPool.map(q => ({ multiplier: q.details.multiplier, count: q.details.count }));
                }

                if (!multipliers || multipliers.length === 0) multipliers = [2];
                const safeCount = Math.max(totalCount || 10, 1);
                const numMultipliers = multipliers.length;
                
                // Calculate base questions per multiplier
                const basePerMul = Math.floor(safeCount / numMultipliers);
                let remainder = safeCount % numMultipliers;

                // For each selected number, generate 'basePerMul' questions
                multipliers.forEach(m => {
                    // Generate full set 1-10 for this multiplier
                    let candidates = Array.from({length: 10}, (_, i) => ({ multiplier: Number(m), count: i + 1 }));
                    
                    // Shuffle candidates
                    for (let i = candidates.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
                    }

                    // Pick required amount. If more needed than 10, repeat.
                    let picks = [];
                    while(picks.length < basePerMul) {
                        picks = picks.concat(candidates);
                    }
                    pool = pool.concat(picks.slice(0, basePerMul));
                });

                // Handle remainder: randomly pick from selected multipliers
                if (remainder > 0) {
                    // Create a pool of all possible combinations for selected multipliers
                    let remainderPool = [];
                    multipliers.forEach(m => {
                         // Just add random ones
                         remainderPool.push({ multiplier: Number(m), count: Math.floor(Math.random() * 10) + 1 });
                    });
                    // Shuffle and take remainder
                    for (let i = remainderPool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [remainderPool[i], remainderPool[j]] = [remainderPool[j], remainderPool[i]];
                    }
                    pool = pool.concat(remainderPool.slice(0, remainder));
                }

                // Final Shuffle of the whole pool
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                
                return pool.slice(0, safeCount);
            };

            const startQuiz = (isRetry = false) => {
                if (isRetry) {
                    const retrySource = wrongQuestions.value;
                    quizQuestions.value = generateQuestionPool([], 0, true, retrySource);
                } else {
                    quizQuestions.value = generateQuestionPool(settings.multipliers, settings.questionCount);
                }
                currentQuestionIndex.value = 0;
                quizResults.value = [];
                resetInputs();
                currentView.value = 'quiz';
                nextTick(() => { questionStartTime.value = Date.now(); });
            };

            const resetInputs = () => { userInputs.a = ''; userInputs.b = ''; userInputs.ans = ''; };

            const submitAnswer = () => {
                const q = currentQuestion.value;
                const endTime = Date.now();
                const duration = (endTime - questionStartTime.value) / 1000; 

                if(q.multiplier === 0) { finishQuiz(); return; }

                const correctAnswer = q.multiplier * q.count;
                let isCorrect = false;
                let userAnsDisplay = "";

                if (settings.answerMode === 'simple') {
                    isCorrect = parseInt(userInputs.ans) === correctAnswer;
                    userAnsDisplay = `${userInputs.ans}`;
                } else {
                    const inputA = parseInt(userInputs.a);
                    const inputB = parseInt(userInputs.b);
                    const inputAns = parseInt(userInputs.ans);
                    const logicCorrect = (inputA === q.multiplier && inputB === q.count) || (inputA === q.count && inputB === q.multiplier);
                    isCorrect = logicCorrect && (inputAns === correctAnswer);
                    userAnsDisplay = `${inputA} Ã— ${inputB} = ${inputAns}`;
                }

                let proficiency = 'unfamiliar';
                if (!isCorrect) {
                    proficiency = 'unfamiliar';
                } else {
                    // Dynamic proficiency logic based on GRADE
                    const gradeGroup = getGradeGroup(studentGrade.value || 1);
                    const groupSettings = proficiencySettings[gradeGroup];
                    const limits = settings.answerMode === 'simple' ? groupSettings.simple : groupSettings.full;
                    
                    if (duration < limits.mastered) {
                        proficiency = 'mastered';
                    } else if (duration <= limits.intermediate) {
                        proficiency = 'intermediate';
                    } else {
                        proficiency = 'unfamiliar';
                    }
                }

                quizResults.value.push({ 
                    q: `${q.multiplier} Ã— ${q.count}`, 
                    correct: isCorrect, 
                    userAns: userAnsDisplay, 
                    details: q,
                    proficiency: proficiency,
                    time: duration.toFixed(1)
                });
                
                if (currentQuestionIndex.value < quizQuestions.value.length - 1) {
                    currentQuestionIndex.value++;
                    resetInputs();
                    nextTick(() => { questionStartTime.value = Date.now(); });
                } else {
                    finishQuiz();
                }
            };

            const finishQuiz = () => {
                const fb = aiFeedback.value;
                let fbText = "";
                if(fb.mastered.length > 0) fbText += `ç²¾ç†Ÿ: ${fb.mastered.join(',')}ã€‚`;
                if(fb.intermediate.length > 0) fbText += `ä¸­ç­‰: ${fb.intermediate.join(',')}ã€‚`;
                if(fb.unfamiliar.length > 0) fbText += `ä¸ç†Ÿ: ${fb.unfamiliar.join(',')}ã€‚`;

                // Capture snapshot of current settings for this grade
                const gradeGroup = getGradeGroup(studentGrade.value || 1);
                const settingsSnapshot = JSON.parse(JSON.stringify(proficiencySettings[gradeGroup]));

                const record = {
                    name: studentName.value,
                    grade: studentGrade.value,
                    timestamp: new Date().toLocaleString(),
                    range: settings.multipliers.join(', '),
                    total: quizQuestions.value.length,
                    score: scorePercentage.value,
                    details: quizResults.value,
                    aiFeedbackText: fbText,
                    settingsSnapshot: settingsSnapshot // Store threshold data
                };
                const records = JSON.parse(localStorage.getItem('studentRecords') || '[]');
                records.unshift(record);
                localStorage.setItem('studentRecords', JSON.stringify(records));
                studentRecords.value = records;
                currentView.value = 'result';
            };

            const retryWrong = () => { startQuiz(true); };
            const checkAdminPass = () => {
                if (adminInputPass.value === currentPassword.value) { currentView.value = 'adminDashboard'; adminInputPass.value = ''; loginMsg.value = ''; } 
                else { loginMsg.value = 'å¯†ç¢¼éŒ¯èª¤'; }
            };
            const updatePassword = () => { if (newPassword.value) { currentPassword.value = newPassword.value; localStorage.setItem('adminPass', newPassword.value); alert('å¯†ç¢¼å·²æ›´æ–°'); newPassword.value = ''; } };
            const resetPassword = () => { if(confirm('ç¢ºå®šæ¢å¾©é è¨­å¯†ç¢¼ 0000ï¼Ÿ')) { currentPassword.value = '0000'; localStorage.setItem('adminPass', '0000'); alert('å·²æ¢å¾©'); } };
            const deleteRecord = (index) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { studentRecords.value.splice(index, 1); localStorage.setItem('studentRecords', JSON.stringify(studentRecords.value)); } };
            const viewRecordDetail = (rec) => { selectedRecord.value = rec; showDetailModal.value = true; };
            
            // --- Export Functions ---
            
            const exportAllRecords = (format = 'txt') => {
                if (format === 'csv') {
                    exportAllRecordsCSV();
                    return;
                }
                let content = "å­¸ç”Ÿä½œç­”ç´€éŒ„åŒ¯å‡º\n-------------------------\n";
                studentRecords.value.forEach(r => { 
                    content += `å§“å: ${r.name} (${r.grade || '?'}å¹´ç´š)\næ™‚é–“: ${r.timestamp}\nåˆ†æ•¸: ${r.score}%\né¡Œç›®ç¯„åœ: ${r.range}\nå»ºè­°: ${r.aiFeedbackText}\n`;
                    if(r.settingsSnapshot) {
                         content += `[ç•¶æ™‚æ¨™æº–] ç°¡å–®æ¨¡å¼:ç²¾${r.settingsSnapshot.simple.mastered}/ä¸­${r.settingsSnapshot.simple.intermediate}, å®Œæ•´æ¨¡å¼:ç²¾${r.settingsSnapshot.full.mastered}/ä¸­${r.settingsSnapshot.full.intermediate}\n`;
                    }
                    content += `-------------------------\n`; 
                });
                downloadFile(content, "all_student_records.txt", 'text/plain');
            };

            const exportAllRecordsCSV = () => {
                // BOM for Excel UTF-8
                let csvContent = "\uFEFF";
                // Header
                csvContent += "å§“å,å¹´ç´š,ä½œç­”æ™‚é–“,åˆ†æ•¸(%),ç¯„åœ,AIå»ºè­°,ç°¡å–®æ¨¡å¼ç²¾ç†Ÿ(ç§’),ç°¡å–®æ¨¡å¼ä¸­ç­‰(ç§’),å®Œæ•´æ¨¡å¼ç²¾ç†Ÿ(ç§’),å®Œæ•´æ¨¡å¼ä¸­ç­‰(ç§’)\n";
                
                studentRecords.value.forEach(r => {
                    let row = [];
                    row.push(`"${r.name}"`);
                    row.push(r.grade || "");
                    row.push(`"${r.timestamp}"`);
                    row.push(r.score);
                    row.push(`"${r.range}"`);
                    row.push(`"${r.aiFeedbackText.replace(/\n/g, ' ')}"`);
                    
                    if (r.settingsSnapshot) {
                        row.push(r.settingsSnapshot.simple.mastered);
                        row.push(r.settingsSnapshot.simple.intermediate);
                        row.push(r.settingsSnapshot.full.mastered);
                        row.push(r.settingsSnapshot.full.intermediate);
                    } else {
                         row.push("","","","");
                    }
                    csvContent += row.join(",") + "\n";
                });
                downloadFile(csvContent, "all_student_records.csv", 'text/csv;charset=utf-8;');
            };
            
            const exportSingleRecord = (r, format = 'txt') => {
                if (format === 'csv') {
                    exportSingleRecordCSV(r);
                    return;
                }
                 let content = `å§“å: ${r.name}\nå¹´ç´š: ${r.grade || 'æœªç´€éŒ„'}\næ™‚é–“: ${r.timestamp}\nåˆ†æ•¸: ${r.score}%\nAIå»ºè­°: ${r.aiFeedbackText}\n`;
                 
                 if(r.settingsSnapshot) {
                     content += `\n[ç•¶æ™‚ç²¾ç†Ÿæ¨™æº–]\nç°¡å–®æ¨¡å¼: ç²¾ç†Ÿ < ${r.settingsSnapshot.simple.mastered}s, ä¸­ç­‰ < ${r.settingsSnapshot.simple.intermediate}s\n`;
                     content += `å®Œæ•´æ¨¡å¼: ç²¾ç†Ÿ < ${r.settingsSnapshot.full.mastered}s, ä¸­ç­‰ < ${r.settingsSnapshot.full.intermediate}s\n`;
                 }

                 content += `\nè©³ç´°ç­”é¡Œåˆ—è¡¨:\n`;
                 r.details.forEach(d => { 
                     let profText = d.proficiency === 'mastered' ? 'ç²¾ç†Ÿ' : (d.proficiency === 'intermediate' ? 'ä¸­ç­‰' : 'ä¸ç†Ÿ');
                     content += `${d.q} | ç­”: ${d.userAns} | ${d.correct ? 'O' : 'X'} | ${profText} (${d.time}s)\n`; 
                 });
                 downloadFile(content, `${r.name}_record.txt`, 'text/plain');
            };

            const exportSingleRecordCSV = (r) => {
                 let csvContent = "\uFEFF";
                 // Metadata part
                 csvContent += `å§“å,${r.name},å¹´ç´š,${r.grade || ''}\n`;
                 csvContent += `æ™‚é–“,${r.timestamp},åˆ†æ•¸,${r.score}%\n`;
                 
                 if (r.settingsSnapshot) {
                      csvContent += `ç°¡å–®æ¨¡å¼æ¨™æº–,ç²¾ç†Ÿ<${r.settingsSnapshot.simple.mastered}s,ä¸­ç­‰<${r.settingsSnapshot.simple.intermediate}s\n`;
                      csvContent += `å®Œæ•´æ¨¡å¼æ¨™æº–,ç²¾ç†Ÿ<${r.settingsSnapshot.full.mastered}s,ä¸­ç­‰<${r.settingsSnapshot.full.intermediate}s\n`;
                 }
                 csvContent += `AIå»ºè­°,"${r.aiFeedbackText.replace(/\n/g, ' ')}"\n\n`;

                 // Details table
                 csvContent += "é¡Œç›®,å­¸ç”Ÿç­”æ¡ˆ,çµæœ,ç²¾ç†Ÿåº¦,ä½œç­”ç§’æ•¸\n";
                 r.details.forEach(d => {
                     let profText = d.proficiency === 'mastered' ? 'ç²¾ç†Ÿ' : (d.proficiency === 'intermediate' ? 'ä¸­ç­‰' : 'ä¸ç†Ÿ');
                     let correctText = d.correct ? 'æ­£ç¢º' : 'éŒ¯èª¤';
                     csvContent += `"${d.q}","${d.userAns}",${correctText},${profText},${d.time}\n`;
                 });
                 
                 downloadFile(csvContent, `${r.name}_record.csv`, 'text/csv;charset=utf-8;');
            };
            
            const downloadFile = (content, filename, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const generateRemedialWorksheet = (record, filterType = 'both') => {
                let weakItems = [];
                let typeName = "";

                if (filterType === 'intermediate') {
                    weakItems = record.details.filter(d => d.proficiency === 'intermediate');
                    typeName = "åƒ…ä¸­ç­‰";
                } else if (filterType === 'unfamiliar') {
                    weakItems = record.details.filter(d => d.proficiency === 'unfamiliar'); // åŒ…å«ç­”éŒ¯æˆ–è¶…æ™‚
                    typeName = "åƒ…ä¸ç†Ÿ";
                } else {
                    // Both (Default)
                    weakItems = record.details.filter(d => d.proficiency !== 'mastered');
                    typeName = "åŠ å¼·";
                }
                
                if(weakItems.length === 0) {
                    alert(`è©²ç”Ÿåœ¨ã€Œ${typeName}ã€é¡åˆ¥ä¸­æ²’æœ‰é¡Œç›®ï¼`);
                    return;
                }

                worksheetQuestions.value = weakItems.map(item => ({
                    multiplier: item.details.multiplier,
                    count: item.details.count
                }));

                worksheetSettings.type = 'block'; 
                worksheetSettings.mode = 'full'; // Force full mode for practice
                worksheetTitle.value = `${typeName}ç·´ç¿’å–® - ${record.name}`;
                
                showDetailModal.value = false;
                currentView.value = 'worksheetPreview';
            };

            const previewWorksheet = () => {
                worksheetQuestions.value = generateQuestionPool(worksheetSettings.multipliers.map(Number), worksheetSettings.count);
                worksheetTitle.value = `ååä¹˜æ³•å­¸ç¿’å–® - ${worksheetSettings.multipliers.sort((a,b)=>a-b).join(', ')}`;
                currentView.value = 'worksheetPreview';
            };

            const printCurrentView = () => {
                window.print();
            };

            const exportResultTxt = () => {
                 let fb = aiFeedback.value;
                 let fbText = "";
                 if(fb.mastered.length > 0) fbText += `ç²¾ç†Ÿ: ${fb.mastered.join(',')}ã€‚`;
                 if(fb.intermediate.length > 0) fbText += `ä¸­ç­‰: ${fb.intermediate.join(',')}ã€‚`;
                 if(fb.unfamiliar.length > 0) fbText += `ä¸ç†Ÿ: ${fb.unfamiliar.join(',')}ã€‚`;

                 let content = `å§“å: ${studentName.value} (${studentGrade.value || '?'}å¹´ç´š)\næ™‚é–“: ${new Date().toLocaleString()}\næ­£ç¢ºç‡: ${scorePercentage.value}%\n\nAI å»ºè­°æ‘˜è¦:\n${fbText}\n\néŒ¯é¡Œåˆ—è¡¨:\n`;
                 wrongQuestions.value.forEach(q => { content += `${q.q} (ä½ çš„ç­”æ¡ˆ: ${q.userAns})\n`; });
                 downloadFile(content, `ç·´ç¿’çµæœ_${studentName.value}.txt`, 'text/plain');
            };
            
            const saveProficiencySettings = () => {
                localStorage.setItem('proficiencySettings', JSON.stringify(proficiencySettings));
                alert('è©•åˆ¤æ¨™æº–å·²å„²å­˜ï¼');
            };

            const getRodClass = (n) => { return `rod-${n}`; };
            
            const getDynamicRodStyle = (multiplier) => {
                const availableH = containerHeight.value || 300;
                let unitHeight = availableH / 12; 
                unitHeight = Math.min(Math.max(unitHeight, 15), 40);
                
                return {
                    height: `${multiplier * unitHeight}px`,
                    width: `${unitHeight}px`, 
                    backgroundSize: `100% ${unitHeight}px`, 
                    marginRight: '4px'
                };
            };

            return {
                currentView, studentName, studentGrade, settings, currentQuestion, currentQuestionIndex, quizQuestions, progressPercent,
                userInputs, submitAnswer, scorePercentage, scoreColor, aiFeedback, wrongQuestions, retryWrong, exportResultTxt,
                startQuiz, goToStudentName, selectAllMultipliers, getRodClass, getDynamicRodStyle, isMobile, rodsContainer,
                adminInputPass, checkAdminPass, loginMsg, adminTab, studentRecords, deleteRecord, viewRecordDetail, showDetailModal, selectedRecord,
                exportAllRecords, exportSingleRecord, showPass, currentPassword, newPassword, updatePassword, resetPassword,
                worksheetSettings, worksheetQuestions, worksheetTitle, paginatedQuestions,
                previewWorksheet, printCurrentView, generateRemedialWorksheet,
                proficiencySettings, saveProficiencySettings
            };
        }
    }).mount('#app');
</script>

</body>
</html>